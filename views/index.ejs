<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/output.css">
    <title><%= title %></title>
  </head>
  <body>
    <%- include('partials/toast') %>
    <h1><%= title %></h1>

    <aside class="sidebar">
      <% if (locals.categories) { %>
        <section>
          <h2>Categories</h2>
          <% if (categories.length > 0) { %>
            <form action="/" method="GET" id="category-filter">
              <div class="categories">
                <% categories.forEach(category => { %>
                  <div class="category" data-id="<%= category.id %>">
                    <label for="category-input-<%= category.id %>" class="label">
                      <input 
                        type="checkbox" 
                        name="category" 
                        id="category-input-<%= category.id %>" 
                        value="<%= category.name %>"
                        <% if (locals.filters?.includes(category.name)) { %>
                          checked
                        <% } %>
                      />
                      <span class="name">
                        <%= category.name %>
                      </span>
                    </label>
  
                    <div hidden class="edit-container">
                      <input type="text" class="inline-edit-input" value="<%= category.name %>" placeholder="Category Name" required/>
                      <button type="button" class="btn-save">✔</button>
                      <button type="button" class="btn-cancel">✖</button>
                    </div>
                    
                    <div class="actions">
                      <button type="button" class="btn-edit">Edit</button>
                      <button type="button" class="btn-delete">Delete</button>
                    </div>
                  </div>
                <% }) %>
              </div>
            </form>
          <% } else { %>
            <span>Could not find any category. Be first to add a new category.</span>
          <% } %>

          <div class="category" id="new-category-row">
            <div hidden class="add-container">
              <input type="text" class="inline-add-input" placeholder="Category Name" required/>
              <button type="button" class="btn-save">✔</button>
              <button type="button" class="btn-cancel">✖</button>
            </div>
            <button type="button" class="btn-add">Add New Category</button>
          </div>

          <div class="filter-actions">
            <button type="submit" form="category-filter">Filter</button>
            <a href="/">
              <button type="button">Clear Filter</button>
            </a>
          </div>
        </section>
      <% } %>
    </aside>

    <main>
      <% if (locals.games) { %>
        <section>
          <h2><%= subtitle %></h2>
          <% if (games.length > 0) { %> 
            <div class="games">
              <% games.forEach(game => { %>
                <div class="game"  data-id="<%= game.id %>">
                  <a href="/games/<%= game.id %>">
                    <span class="name">
                      <%= game.name %>
                    </span>
                    <p class="description">
                      <%= game.description %>
                    </p>
                    <span class="price">
                      $ <%= game.price %>
                    </span>
                  </a>

                  <div class="game-categories">
                    <% if (game.categories.length > 0) { %>
                      <% game.categories.forEach(category => { %>
                        <div class="game-category-item" data-id="<%= category.id %>">
                          <%= category.name %>
                          <button type="button" class="btn-remove-category" title="Remove category">✖</button>
                        </div>
                      <% }) %>
                    <% } %>
                    
                    <div class="add-category-wrapper">
                      <button type="button" class="btn-add-category">Add Category</button>
                      <div hidden class="add-category-container">
                        <select class="inline-category-select">
                          <option value="" disabled selected>Select category</option>
                          <% if (locals.categories) { %>
                            <% categories.forEach(cat => { %>
                              <% if (!game.categories.some(gc => gc.id === cat.id)) { %>
                                <option value="<%= cat.id %>"><%= cat.name %></option>
                              <% } %>
                            <% }) %>
                          <% } %>
                        </select>
                        <button type="button" class="btn-save-category">✔</button>
                        <button type="button" class="btn-cancel-category">✖</button>
                      </div>
                    </div>
                  </div>
                    
                  <div hidden class="edit-container">
                    <input type="text" class="inline-edit-input" value="<%= game.name %>" placeholder="Game Name" required />
                    <textarea
                      name="description"
                      class="inline-add-description"
                      placeholder="Some fancy description about the game..."
                      required
                    ><%= game.description %> </textarea>
                    <input type="number" name="price" class="inline-add-price" value="<%= game.price %>" placeholder="19.99" required>
                    <button type="button" class="btn-save">✔</button>
                    <button type="button" class="btn-cancel">✖</button>
                  </div>
                  
                  <div class="actions">
                    <button type="button" class="btn-edit">Edit</button>
                    <button type="button" class="btn-delete">Delete</button>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else if (locals.categories?.length > 0) { %>
            <span>Could not find any game with given categories.</span>
          <% } else { %>
            <span>Could not find any game. Be first to add a new game.</span>
          <% } %>
                  
          <div class="game" id="new-game-row">
            <div hidden class="add-container">
              <input type="text" class="inline-add-input" placeholder="Game Name" required />
              <textarea 
                name="description"
                class="inline-add-description"
                placeholder="Some fancy description about the game..."
                required
              ></textarea>
              <input type="number" name="price" class="inline-add-price" required>
              <button type="button" class="btn-save">✔</button>
              <button type="button" class="btn-cancel">✖</button>
            </div>
            <button type="button" class="btn-add">Add New Game</button>
          </div>
        </section>
      <% } %>

    </main>

    <div hidden class="forms">
      <form id="category-add" action="/categories/new" method="POST">
        <input hidden type="text" name="name" required />
      </form>

      <form hidden id="category-update" action="/categories/categoryId/update" method="POST">
        <input hidden type="text" name="name" required />
      </form>

      <form hidden id="game-add" action="/games/new" method="POST">
        <input hidden type="text" name="name" required />
        <textarea hidden name="description" required></textarea>
        <input hidden type="number" name="price" required />
      </form>

      <form hidden id="game-update" action="/games/gameId/update" method="POST">
        <input hidden type="text" name="name" required />
        <textarea hidden name="description" required></textarea>
        <input hidden type="number" name="price" required />
      </form>

      <form id="game-remove-category" action="/games/gameId/removeCategory" method="post">
        <input hidden type="text" name="categoryId">
      </form>

      <form hidden id="game-add-category" action="/games/gameId/addCategory" method="POST">
        <input hidden type="text" name="categoryId" required />
      </form>
    </div>

    <dialog id="delete-dialog">
      <form method="dialog">
        <h3>Admin Access Required</h3>
        <p>Please enter the admin password to delete this category.</p>
        <input type="password" id="dialog-password-input"/>
        <div class="dialog-actions">
          <button value="cancel">Cancel</button>
          <button id="confirm-delete-btn" type="button">Delete</button>
        </div>
        <p id="dialog-error-msg"></p>
      </form>
    </dialog>

    <script src="/js/toast.js" defer></script>
    <script src="/js/gameCategoryManager.js" defer></script>
    <script src="/js/main.js" defer></script>
  </body>
</html>