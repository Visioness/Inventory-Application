<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/output.css">
    <title><%= title %></title>
  </head>
  <body class="h-screen grid grid-rows-[auto_1fr_auto] grid-cols-[1fr] overflow-hidden">
    <header class="relative flex justify-center items-center col-span-2 border-b-2 border-neutral-300 p-4">
      <a href="/" class="absolute left-2 md:left-4 flex items-center gap-1 text-neutral-600 hover:text-amber-500 transition-colors duration-300 font-bold">
        <span class="h-lh text-base md:text-xl">< Back</span> 
      </a>
      <h1 class="text-xl md:text-3xl font-bold px-20 md:px-0 text-center"><%= title %></h1>
    </header>

    <main class="overflow-y-auto p-4 flex flex-col items-center">
      <% if (locals.game) { %>
        <div class="game relative flex flex-col gap-4 border-2 rounded-lg p-8 max-w-2xl mx-auto" data-id="<%= game.id %>">
          <span class="name flex justify-center items-center text-2xl font-bold text-neutral-800 mb-4">
            <%= game.name %>
          </span>
          <p class="description text-lg text-neutral-700 mb-4 leading-relaxed">
            <%= game.description %>
          </p>
          <span class="price text-xl font-semibold text-green-600 mb-6">
            $ <%= game.price %>
          </span>

          <div hidden class="edit-container flex flex-col gap-4">
            <input type="text"
              class="inline-edit-input text-2xl font-bold text-neutral-800 border-b-1 border-neutral-300 focus:border-amber-500 outline-none bg-transparent placeholder-neutral-400"
              value="<%= game.name %>" placeholder="Game Name" required />
            <textarea name="description"
              class="inline-add-description text-lg text-neutral-700 border-b-1 border-neutral-300 focus:border-amber-500 outline-none bg-transparent placeholder-neutral-400 resize-none h-32 leading-relaxed"
              placeholder="Some fancy description about the game..." required><%= game.description %></textarea>
            <input type="number" name="price"
              class="inline-add-price text-xl font-semibold text-green-600 border-b-1 border-neutral-300 focus:border-amber-500 outline-none bg-transparent placeholder-neutral-400"
              value="<%= game.price %>" placeholder="19.99" required>
            <div class="flex gap-2">
              <button type="button"
                class="btn-save flex justify-center items-center w-8 h-8 bg-green-500 hover:bg-green-600 text-white rounded-full transition-colors duration-300 cursor-pointer"
                title="Save Edit">✓</button>
              <button type="button"
                class="btn-cancel flex justify-center items-center w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors duration-300 cursor-pointer"
                title="Cancel">✕</button>
            </div>
          </div>

          <hr class="h-0.5 border-none bg-neutral-200 rounded-full">

          <div class="game-categories flex flex-wrap gap-2">
            <% if (game.categories.length > 0) { %>
              <% game.categories.forEach(category => { %>
                <div class="h-max game-category-item flex border-1 border-neutral-300 bg-neutral-200 text-neutral-600 text-xs rounded-full" data-id="<%= category.id %>">
                  <span class="name flex justify-center items-center px-2 py-1 text-[14px] font-bold">
                    <%= category.name %>
                  </span>
                  <button type="button" class="btn-remove-category flex justify-center items-center w-6 bg-neutral-100 hover:bg-neutral-300 group-has-[:checked]:bg-amber-500 group-has-[:checked]:hover:bg-amber-600 text-neutral-800 transition-colors duration-300 rounded-r-xl cursor-pointer" title="Remove category">✕</button>
                </div>
              <% }) %>
            <% } %>
            
            <div class="add-category-wrapper text-xs">
              <button type="button" class="btn-add-category flex items-center border-1 border-neutral-300 bg-neutral-200 hover:bg-neutral-300 text-neutral-600 rounded-full px-2 py-1 text-[14px] font-bold cursor-pointer transition-colors duration-300" title="New Category">✚ New Category</button>
              <div hidden class="add-category-container h-max flex border-1 border-neutral-300 bg-neutral-200 text-neutral-600 text-xs rounded-full">
                <div class="relative flex items-center rounded-l-full">
                  <select name="category" class="inline-category-select max-w-48 appearance-none bg-transparent rounded-l-full pl-2 pr-6 py-1 text-[14px] font-bold cursor-pointer">
                    <option value="" disabled selected>Select category</option>
                    <% if (locals.categories) { %>
                      <% categories.forEach(cat => { %>
                        <% if (!game.categories.some(gc => gc.id === cat.id)) { %>
                          <option class="p-4" value="<%= cat.id %>">
                            <span class="max-w-32 p-4 overflow-hidden text-ellipsis whitespace-nowrap"><%= cat.name %></span>
                          </option>
                        <% } %>
                      <% }) %>
                    <% } %>
                  </select>
                  <span class="pointer-events-none absolute right-2 text-[8px] font-bold">▼</span>
                </div>
                <button type="button" class="btn-save-category flex justify-center items-center w-6 bg-neutral-100 hover:bg-neutral-400 transition-colors duration-300 cursor-pointer" title="Add">✓</button>
                <button type="button" class="btn-cancel-category flex justify-center items-center w-6 bg-neutral-100 hover:bg-neutral-400 transition-colors duration-300 rounded-r-xl cursor-pointer" title="Cancel">✕</button>
              </div>
            </div>
          </div>
          
          <div class="actions absolute top-2 right-2 flex border-1 border-neutral-300 rounded-sm">
            <button type="button" class="btn-edit flex justify-center items-center w-6 bg-blue-200 hover:bg-blue-300 text-neutral-800 transition-colors duration-300 rounded-l-sm cursor-pointer" title="Edit">✎</button>
            <button type="button" class="btn-delete flex justify-center items-center w-6 bg-red-200 hover:bg-red-300 text-neutral-800 transition-colors duration-300 rounded-r-sm cursor-pointer" title="Delete">✘</button>
          </div>
        </div>

        <form id="game-remove-category" action="/games/gameId/removeCategory" method="post">
            <input hidden type="text" name="categoryId">
        </form>

        <form hidden id="game-add-category" action="/games/gameId/addCategory" method="POST">
          <input hidden type="text" name="categoryId" required />
        </form>

        <form hidden id="game-update" action="/games/gameId/update" method="POST">
          <input hidden type="text" name="name" required />
          <textarea hidden name="description" required></textarea>
          <input hidden type="number" name="price" required />
        </form>

        <dialog id="delete-dialog" class="backdrop:bg-black/30 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 m-0 rounded-lg border-2 border-neutral-300 shadow-xl p-0 w-full max-w-md">
          <form method="dialog" class="flex flex-col gap-4 p-6">
            <h3 class="text-xl font-bold text-neutral-800">Admin Access Required</h3>
            <p class="text-sm text-neutral-600">Please enter the admin password to delete this item.</p>
            <input type="password" id="dialog-password-input" class="w-full px-4 py-2 border-2 border-neutral-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors duration-300"/>
            <div class="dialog-actions flex gap-2 justify-end">
              <button value="cancel" class="px-4 py-2 bg-neutral-200 hover:bg-neutral-300 text-neutral-800 font-semibold rounded-lg transition-colors duration-300 cursor-pointer">Cancel</button>
              <button id="confirm-delete-btn" type="button" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors duration-300 cursor-pointer">Delete</button>
            </div>
            <p id="dialog-error-msg" class="text-sm text-red-600 font-semibold text-center"></p>
          </form>
        </dialog>

        <%- include('partials/toast') %>
      <% } else { %>
        <p class="error-message">
          Could not find the game.
        </p>
      <% } %>
    </main>

    <footer class="col-span-2 border-t-2 border-neutral-300 p-1 flex justify-center items-center">
      <span class="text-md font-bold">by Visioness</span>
    </footer>

    <script src="/js/toast.js" defer></script>
    <script src="/js/gameCategoryManager.js" defer></script>
    <script src="/js/main.js" defer></script>
  </body>
</html>